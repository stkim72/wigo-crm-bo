<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ceragem.crm.mem.dao.PromotionListDao">
    <sql id="sqlPkConditions">
                WHERE MSHIP_PROM_BAS_NO =       #{mshipPromBasNo}
    </sql>
    <sql id="sqlCols">
                      MSHIP_PROM_BAS_NO                    /*멤버십프로모션기본번호        */
                    , PROM_STA_YMD                    /*프로모션시작년월일        */
                    , PROM_TYPE_CD                    /*프로모션유형코드        */
                    , PROM_END_YMD                    /*프로모션종료년월일        */
                    , REGR_ID                    /*등록자ID        */
                    , REG_DT                    /*등록일시        */
                    , AMDR_ID                    /*수정자ID        */
                    , PROM_BAS_CTNTS                    /*프로모션기본내용        */
                    , AMD_DT                    /*수정일시        */
                    , REG_CHL_CD                    /*등록채널코드        공통코드 : S000        [CRM : CRM , CTC : 상담 , AS : AS , SAP : SAP , POS : POS]*/
                    , ADVM_SHOW_YN                    /*광고노출여부        */
                    , USE_CHL_PLCY_CD                    /*사용채널정책코드        */
                    , FROM_APPLY_SALE_AMT                    /*FROM적용매출금액        */
                    , TO_APPLY_SALE_AMT                    /*TO적용매출금액        */
                    , FROM_APPLY_SALE_COND_CD                    /*FROM적용매출조건코드        */
                    , TO_APPLY_SALE_COND_CD                    /*TO적용매출조건코드        */
                    , FROM_APPLY_PAY_AMT                    /*FROM적용결제금액        */
                    , TO_APPLY_PAY_AMT                    /*TO적용결제금액        */
                    , FROM_APPLY_PAY_COND_CD                    /*FROM적용결제조건코드        */
                    , TO_APPLY_PAY_COND_CD                    /*TO적용결제조건코드        */
                    , APPLY_MSHIP_GRADE_CD                    /*적용멤버십등급코드        */
                    , DUP_USE_YN                    /*중복사용여부        */
                    , APPLY_BNFIT_CD                    /*적용혜택코드        */
                    , COUPN_APPLY_DIV_CD1                    /*쿠폰적용구분코드1        */
                    , COUPN_APPLY_DIV_CD2                    /*쿠폰적용구분코드2        */
                    , APPLY_DC_RATE                    /*적용할인율        */
                    , APPLY_DC_AMT                    /*적용할인금액        */
                    , POINT_ACCUM_RATE                    /*포인트적립율        */
                    , STMP_PRV_CNT                    /*스탬프제공수        */
                    , PRV_COUPN_BAS_NO                    /*제공쿠폰기본번호        */
                    , STATUS_CD                    /*상태코드        */
                    , PROM_BAS_NM                    /*프로모션기본명        */
                    , APPLY_MSHP_GRADE_CTNTS                    /*적용회원등급내용        */
                    , APPLY_MSHIP_GRADE_CD1                    /*적용멤버십등급코드1        */
                    , CPRT_CMP_NO                    /*제휴회사번호        */
                    , APPLY_POINT_SCORE                    /*적용포인트점수        */
                    , MSHIP_TYPE_CDS						/*회원형태*/
    </sql>
    <sql id="sqlSelectCols">
                      A.MSHIP_PROM_BAS_NO                    /*멤버십프로모션기본번호        */
                    , A.PROM_STA_YMD                    /*프로모션시작년월일        */
                    , A.PROM_TYPE_CD                    /*프로모션유형코드        */
                    , A.PROM_END_YMD                    /*프로모션종료년월일        */
                    , A.REGR_ID                    /*등록자ID        */
                    , TO_CHAR(A.REG_DT,'YYYYMMDDHH24MISS')    REG_DT                    /*등록일시        */
                    , A.AMDR_ID                    /*수정자ID        */
                    , A.PROM_BAS_CTNTS                    /*프로모션기본내용        */
                    , TO_CHAR(A.AMD_DT,'YYYYMMDDHH24MISS')    AMD_DT                    /*수정일시        */
                    , A.REG_CHL_CD                    /*등록채널코드        공통코드 : S000        [CRM : CRM , CTC : 상담 , AS : AS , SAP : SAP , POS : POS]*/
                    , A.ADVM_SHOW_YN                    /*광고노출여부        */
                    , A.USE_CHL_PLCY_CD                    /*사용채널정책코드        */
                    , A.FROM_APPLY_SALE_AMT                    /*FROM적용매출금액        */
                    , A.TO_APPLY_SALE_AMT                    /*TO적용매출금액        */
                    , A.FROM_APPLY_SALE_COND_CD                    /*FROM적용매출조건코드        */
                    , A.TO_APPLY_SALE_COND_CD                    /*TO적용매출조건코드        */
                    , A.FROM_APPLY_PAY_AMT                    /*FROM적용결제금액        */
                    , A.TO_APPLY_PAY_AMT                    /*TO적용결제금액        */
                    , A.FROM_APPLY_PAY_COND_CD                    /*FROM적용결제조건코드        */
                    , A.TO_APPLY_PAY_COND_CD                    /*TO적용결제조건코드        */
                    , A.APPLY_MSHIP_GRADE_CD                    /*적용멤버십등급코드        */
                    , A.DUP_USE_YN                    /*중복사용여부        */
                    , A.APPLY_BNFIT_CD                    /*적용혜택코드        */
                    , A.COUPN_APPLY_DIV_CD1                    /*쿠폰적용구분코드1        */
                    , A.COUPN_APPLY_DIV_CD2                    /*쿠폰적용구분코드2        */
                    , A.APPLY_DC_RATE                    /*적용할인율        */
                    , A.APPLY_DC_AMT                    /*적용할인금액        */
                    , A.POINT_ACCUM_RATE                    /*포인트적립율        */
                    , A.STMP_PRV_CNT                    /*스탬프제공수        */
                    , A.PRV_COUPN_BAS_NO                    /*제공쿠폰기본번호        */
                    , (SELECT COUPN_BAS_NM FROM CRM_MSHIP_COUPN_BAS WHERE MSHIP_COUPN_BAS_NO = A.PRV_COUPN_BAS_NO) AS COUPN_BAS_NM /*제공쿠폰명        */
                    , (SELECT COMN_CD_NM FROM CRM_COMN_CD_BAS C WHERE C.TOP_COMN_CD = 'PM110' AND C.COMN_CD = A.STATUS_CD ) STATUS_NM
                    , A.STATUS_CD                    /*상태코드        */
                    , A.PROM_BAS_NM                    /*프로모션기본명        */
                    , A.APPLY_MSHP_GRADE_CTNTS                    /*적용회원등급내용        */
                    , A.APPLY_MSHIP_GRADE_CD1                    /*적용멤버십등급코드1        */
                    , A.CPRT_CMP_NO                    /*제휴회사번호        */
                    , A.APPLY_POINT_SCORE                    /*적용포인트점수        */
                    , A.MSHIP_TYPE_CDS						/*회원형태*/
    </sql>
    
    <sql id="sqlConditions">
        <where>
	        <if test="searchPromStaYmd != null and searchPromStaYmd != ''">
	                  AND A.PROM_STA_YMD    =       #{searchPromStaYmd}
	        </if>
	        <if test="searchPromTypeCd != null and searchPromTypeCd != ''">
	            <choose>
	                <when test="searchPromTypeCd instanceof String">
	                    AND A.PROM_TYPE_CD    =       #{searchPromTypeCd}
	                </when>
	                <otherwise>
	                    AND A.PROM_TYPE_CD    IN
	                    <foreach item="item" index="index" collection="searchPromTypeCd" open="(" separator="," close=")">
	                        #{item}
	                    </foreach>
	                </otherwise>
	            </choose>
	        </if>
	        <if test="searchPromEndYmd != null and searchPromEndYmd != ''">
	                  AND A.PROM_END_YMD    =       #{searchPromEndYmd}
	        </if>
	        <if test="searchStatusCd != null and searchStatusCd != ''">
	            <choose>
	                <when test="searchStatusCd instanceof String">
	                    AND A.STATUS_CD       =       #{searchStatusCd}
	                </when>
	                <otherwise>
	                    AND A.STATUS_CD       IN
	                    <foreach item="item" index="index" collection="searchStatusCd" open="(" separator="," close=")">
	                        #{item}
	                    </foreach>
	                </otherwise>
	            </choose>
	        </if>
	        <if test="searchPromBasNm != null and searchPromBasNm != ''">
	                  AND PROM_BAS_NM     LIKE    '%' ||  #{searchPromBasNm} || '%'
	        </if>
		</where>
    </sql>
    <sql id="sqlOrderBy">
        <choose>
            <when test="colSortName ==null or colSortName == ''">
                ORDER BY      REG_DT DESC
            </when>
            <when test="colSortName.equals('mshipPromBasNo')">
                ORDER BY      MSHIP_PROM_BAS_NO
            </when>
            <when test="colSortName.equals('promStaYmd')">
                ORDER BY      PROM_STA_YMD
            </when>
            <when test="colSortName.equals('promTypeCd')">
                ORDER BY      PROM_TYPE_CD
            </when>
            <when test="colSortName.equals('promEndYmd')">
                ORDER BY      PROM_END_YMD
            </when>
            <when test="colSortName.equals('regrId')">
                ORDER BY      REGR_ID
            </when>
            <when test="colSortName.equals('regDt')">
                ORDER BY      REG_DT
            </when>
            <when test="colSortName.equals('amdrId')">
                ORDER BY      AMDR_ID
            </when>
            <when test="colSortName.equals('promBasCtnts')">
                ORDER BY      PROM_BAS_CTNTS
            </when>
            <when test="colSortName.equals('amdDt')">
                ORDER BY      AMD_DT
            </when>
            <when test="colSortName.equals('regChlCd')">
                ORDER BY      REG_CHL_CD
            </when>
            <when test="colSortName.equals('advmShowYn')">
                ORDER BY      ADVM_SHOW_YN
            </when>
            <when test="colSortName.equals('useChlPlcyCd')">
                ORDER BY      USE_CHL_PLCY_CD
            </when>
            <when test="colSortName.equals('fromApplySaleAmt')">
                ORDER BY      FROM_APPLY_SALE_AMT
            </when>
            <when test="colSortName.equals('toApplySaleAmt')">
                ORDER BY      TO_APPLY_SALE_AMT
            </when>
            <when test="colSortName.equals('fromApplySaleCondCd')">
                ORDER BY      FROM_APPLY_SALE_COND_CD
            </when>
            <when test="colSortName.equals('toApplySaleCondCd')">
                ORDER BY      TO_APPLY_SALE_COND_CD
            </when>
            <when test="colSortName.equals('fromApplyPayAmt')">
                ORDER BY      FROM_APPLY_PAY_AMT
            </when>
            <when test="colSortName.equals('toApplyPayAmt')">
                ORDER BY      TO_APPLY_PAY_AMT
            </when>
            <when test="colSortName.equals('fromApplyPayCondCd')">
                ORDER BY      FROM_APPLY_PAY_COND_CD
            </when>
            <when test="colSortName.equals('toApplyPayCondCd')">
                ORDER BY      TO_APPLY_PAY_COND_CD
            </when>
            <when test="colSortName.equals('applyMshipGradeCd')">
                ORDER BY      APPLY_MSHIP_GRADE_CD
            </when>
            <when test="colSortName.equals('dupUseYn')">
                ORDER BY      DUP_USE_YN
            </when>
            <when test="colSortName.equals('applyBnfitCd')">
                ORDER BY      APPLY_BNFIT_CD
            </when>
            <when test="colSortName.equals('coupnApplyDivCd1')">
                ORDER BY      COUPN_APPLY_DIV_CD1
            </when>
            <when test="colSortName.equals('coupnApplyDivCd2')">
                ORDER BY      COUPN_APPLY_DIV_CD2
            </when>
            <when test="colSortName.equals('applyDcRate')">
                ORDER BY      APPLY_DC_RATE
            </when>
            <when test="colSortName.equals('applyDcAmt')">
                ORDER BY      APPLY_DC_AMT
            </when>
            <when test="colSortName.equals('pointAccumRate')">
                ORDER BY      POINT_ACCUM_RATE
            </when>
            <when test="colSortName.equals('stmpPrvCnt')">
                ORDER BY      STMP_PRV_CNT
            </when>
            <when test="colSortName.equals('prvCoupnBasNo')">
                ORDER BY      PRV_COUPN_BAS_NO
            </when>
            <when test="colSortName.equals('statusCd')">
                ORDER BY      STATUS_CD
            </when>
            <when test="colSortName.equals('promBasNm')">
                ORDER BY      PROM_BAS_NM
            </when>
            <when test="colSortName.equals('applyMshpGradeCtnts')">
                ORDER BY      APPLY_MSHP_GRADE_CTNTS
            </when>
            <when test="colSortName.equals('applyMshipGradeCd1')">
                ORDER BY      APPLY_MSHIP_GRADE_CD1
            </when>
            <when test="colSortName.equals('cprtCmpNo')">
                ORDER BY      CPRT_CMP_NO
            </when>
            <when test="colSortName.equals('applyPointScore')">
                ORDER BY      APPLY_POINT_SCORE
            </when>
            <otherwise>
                ORDER BY      REG_DT
            </otherwise>
        </choose>
        <if test="colSortName !=null and colSortDir !='' and colSortDir !=null and colSortDir !='' and colSortDir.equals('desc')">
            DESC
        </if>
    </sql>
    <select id="selectListCount" resultType="int">
                SELECT /* com.ceragem.crm.mem.dao.PromotionListDao.selectListCount */ COUNT(1)
                 FROM CRM_MSHIP_PROM_BAS A
        <include refid="sqlConditions"/>
    </select>
    <select id="selectList" resultType="com.ceragem.crm.mem.model.PromotionListVo">
        <include refid="com.ceragem.crm.sys.dao.CrmCommonDao.pagingHeader"/>
               SELECT /* com.ceragem.crm.mem.dao.PromotionListDao.selectList */ <include refid="sqlSelectCols"/>
                 FROM CRM_MSHIP_PROM_BAS A
        <include refid="sqlConditions"/>
        <include refid="sqlOrderBy"/>
        <include refid="com.ceragem.crm.sys.dao.CrmCommonDao.pagingFooter"/>
    </select>
    <select id="select" resultType="com.ceragem.crm.mem.model.PromotionListVo">
               SELECT /* com.ceragem.crm.mem.dao.PromotionListDao.select */ <include refid="sqlSelectCols"/>
                 FROM CRM_MSHIP_PROM_BAS A
        <include refid="sqlPkConditions"/>
    </select>
    <insert id="insert">
    			<selectKey order="BEFORE" keyProperty="mshipPromBasNo" resultType="String">
		    		SELECT FN_CRM_AUTO_SEQ('PRM') FROM DUAL
		    	</selectKey>
		    	
                INSERT /* com.ceragem.crm.mem.dao.PromotionListDao.insert */ INTO CRM_MSHIP_PROM_BAS (
        <include refid="sqlCols"/>
                 ) VALUES (
                       #{mshipPromBasNo}
                     , #{promStaYmd}
                     , #{promTypeCd}
                     , #{promEndYmd}
                     , #{regrId}
                     , SYSDATE
                     , #{amdrId}
                     , #{promBasCtnts}
                     , SYSDATE
                     , #{regChlCd}
                     , NVL(#{advmShowYn},'N')
                     , #{useChlPlcyCd}
                     , #{fromApplySaleAmt}
                     , #{toApplySaleAmt}
                     , #{fromApplySaleCondCd}
                     , #{toApplySaleCondCd}
                     , #{fromApplyPayAmt}
                     , #{toApplyPayAmt}
                     , #{fromApplyPayCondCd}
                     , #{toApplyPayCondCd}
                     , #{applyMshipGradeCd}
                     , NVL(#{dupUseYn},'N')
                     , #{applyBnfitCd}
                     , #{coupnApplyDivCd1}
                     , #{coupnApplyDivCd2}
                     , #{applyDcRate}
                     , #{applyDcAmt}
                     , #{pointAccumRate}
                     , #{stmpPrvCnt}
                     , #{prvCoupnBasNo}
                     , #{statusCd}
                     , #{promBasNm}
                     , #{applyMshpGradeCtnts}
                     , #{applyMshipGradeCd1}
                     , #{cprtCmpNo}
                     , #{applyPointScore}
                     , #{mshipTypeCds}
                 )
    </insert>
    <update id="update">
               UPDATE /* com.ceragem.crm.mem.dao.PromotionListDao.update */ CRM_MSHIP_PROM_BAS
                  SET PROM_STA_YMD                            =         #{promStaYmd}
                    , PROM_TYPE_CD                            =         #{promTypeCd}
                    , PROM_END_YMD                            =         #{promEndYmd}
                    , AMDR_ID                                 =         #{amdrId}
                    , PROM_BAS_CTNTS                          =         #{promBasCtnts}
                    , AMD_DT                                  =         SYSDATE
                    , REG_CHL_CD                              =         #{regChlCd}
                    , ADVM_SHOW_YN                            =         NVL(#{advmShowYn},'N')
                    , USE_CHL_PLCY_CD                         =         #{useChlPlcyCd}
                    , FROM_APPLY_SALE_AMT                     =         #{fromApplySaleAmt}
                    , TO_APPLY_SALE_AMT                       =         #{toApplySaleAmt}
                    , FROM_APPLY_SALE_COND_CD                 =         #{fromApplySaleCondCd}
                    , TO_APPLY_SALE_COND_CD                   =         #{toApplySaleCondCd}
                    , FROM_APPLY_PAY_AMT                      =         #{fromApplyPayAmt}
                    , TO_APPLY_PAY_AMT                        =         #{toApplyPayAmt}
                    , FROM_APPLY_PAY_COND_CD                  =         #{fromApplyPayCondCd}
                    , TO_APPLY_PAY_COND_CD                    =         #{toApplyPayCondCd}
                    , APPLY_MSHIP_GRADE_CD                    =         #{applyMshipGradeCd}
                    , DUP_USE_YN                              =         NVL(#{dupUseYn},'N')
                    , APPLY_BNFIT_CD                          =         #{applyBnfitCd}
                    , COUPN_APPLY_DIV_CD1                     =         #{coupnApplyDivCd1}
                    , COUPN_APPLY_DIV_CD2                     =         #{coupnApplyDivCd2}
                    , APPLY_DC_RATE                           =         #{applyDcRate}
                    , APPLY_DC_AMT                            =         #{applyDcAmt}
                    , POINT_ACCUM_RATE                        =         #{pointAccumRate}
                    , STMP_PRV_CNT                            =         #{stmpPrvCnt}
                    , PRV_COUPN_BAS_NO                        =         #{prvCoupnBasNo}
                    , STATUS_CD                               =         #{statusCd}
                    , PROM_BAS_NM                             =         #{promBasNm}
                    , APPLY_MSHP_GRADE_CTNTS                  =         #{applyMshpGradeCtnts}
                    , APPLY_MSHIP_GRADE_CD1                   =         #{applyMshipGradeCd1}
                    , CPRT_CMP_NO                             =         #{cprtCmpNo}
                    , APPLY_POINT_SCORE                       =         #{applyPointScore}
                    , MSHIP_TYPE_CDS						  =			#{mshipTypeCds}
        <include refid="sqlPkConditions"/>
    </update>
    <delete id="delete">
               DELETE /* com.ceragem.crm.mem.dao.PromotionListDao.delete */
                 FROM CRM_MSHIP_PROM_BAS
        <include refid="sqlPkConditions"/>
    </delete>
    
    <!-- 프로모션 복사 -->
    <insert id="copyPromotion">
    	INSERT INTO CRM_MSHIP_PROM_BAS (
			  MSHIP_PROM_BAS_NO        
			, PROM_STA_YMD           
			, PROM_TYPE_CD           
			, PROM_END_YMD           
			, REGR_ID                
			, REG_DT                 
			, AMDR_ID                
			, PROM_BAS_CTNTS         
			, AMD_DT                 
			, REG_CHL_CD             
			, ADVM_SHOW_YN           
			, USE_CHL_PLCY_CD        
			, FROM_APPLY_SALE_AMT    
			, TO_APPLY_SALE_AMT      
			, FROM_APPLY_SALE_COND_CD
			, TO_APPLY_SALE_COND_CD  
			, FROM_APPLY_PAY_AMT     
			, TO_APPLY_PAY_AMT       
			, FROM_APPLY_PAY_COND_CD 
			, TO_APPLY_PAY_COND_CD   
			, APPLY_MSHIP_GRADE_CD   
			, DUP_USE_YN             
			, APPLY_BNFIT_CD         
			, COUPN_APPLY_DIV_CD1    
			, COUPN_APPLY_DIV_CD2    
			, APPLY_DC_RATE          
			, APPLY_DC_AMT           
			, POINT_ACCUM_RATE       
			, STMP_PRV_CNT           
			, PRV_COUPN_BAS_NO       
			, STATUS_CD              
			, PROM_BAS_NM            
			, APPLY_MSHP_GRADE_CTNTS 
			, APPLY_MSHIP_GRADE_CD1  
			, CPRT_CMP_NO            
			, APPLY_POINT_SCORE
			, MSHIP_TYPE_CDS      		 
		) 
		SELECT  
			  FN_CRM_AUTO_SEQ('PRM') AS MSHIP_PROM_BAS_NO	
			, PROM_STA_YMD           
			, PROM_TYPE_CD           
			, PROM_END_YMD           
			, #{regrId} AS REGR_ID                
			, SYSDATE AS REG_DT                 
			, #{amdrId} AS AMDR_ID                
			, PROM_BAS_CTNTS         
			, SYSDATE AS AMD_DT                 
			, REG_CHL_CD             
			, ADVM_SHOW_YN           
			, USE_CHL_PLCY_CD        
			, FROM_APPLY_SALE_AMT    
			, TO_APPLY_SALE_AMT      
			, FROM_APPLY_SALE_COND_CD
			, TO_APPLY_SALE_COND_CD  
			, FROM_APPLY_PAY_AMT     
			, TO_APPLY_PAY_AMT       
			, FROM_APPLY_PAY_COND_CD 
			, TO_APPLY_PAY_COND_CD   
			, APPLY_MSHIP_GRADE_CD   
			, DUP_USE_YN             
			, APPLY_BNFIT_CD         
			, COUPN_APPLY_DIV_CD1    
			, COUPN_APPLY_DIV_CD2    
			, APPLY_DC_RATE          
			, APPLY_DC_AMT           
			, POINT_ACCUM_RATE       
			, STMP_PRV_CNT           
			, PRV_COUPN_BAS_NO       
			, STATUS_CD              
			, PROM_BAS_NM            
			, APPLY_MSHP_GRADE_CTNTS 
			, APPLY_MSHIP_GRADE_CD1  
			, CPRT_CMP_NO            
			, APPLY_POINT_SCORE
			, MSHIP_TYPE_CDS
		FROM CRM_MSHIP_PROM_BAS
			WHERE MSHIP_PROM_BAS_NO = #{mshipPromBasNo}
    </insert>
	
	<!-- bos,pos 공통 -->
	<!-- bos + pos 회원 기준 sum 값 이 조건에 해당 -->
    <select id="getOrderList" resultType="EzMap">
    	SELECT * FROM (
		    SELECT 
		        GRP.ITG_CUST_NO
		        , SUM(GRP.TOT_ORD_AMT) AS TOT_ORD_AMT
		        , LISTAGG(GRP.BOS_ORD_NO, ',') WITHIN GROUP(ORDER BY GRP.BOS_ORD_NO) AS BOS_ORD_NOS
		        , LISTAGG(GRP.POS_ORD_NO, ',') WITHIN GROUP(ORDER BY GRP.POS_ORD_NO) AS POS_ORD_NOS
		     FROM (
		        SELECT 
		            TEM.ITG_CUST_NO
		            , CASE
		                WHEN TEM.SALE_TY_CD = '1401' OR TEM.SALE_TY_CD = '1402' OR TEM.SALE_TY_CD = '1403' OR TEM.SALE_TY_CD = '1404' THEN (TEM.SETL_AMT + TEM.RENT_AMT) * TEM.CNTR_PD_VAL
		                WHEN TEM.SALE_TY_CD = '2101' OR TEM.SALE_TY_CD = '2102' OR TEM.SALE_TY_CD = '2103' OR TEM.SALE_TY_CD = '2104' OR TEM.SALE_TY_CD = '1202' THEN TEM.SETL_AMT
		                WHEN TEM.SALE_TY_CD = '2401' THEN TEM.SETL_AMT
		            END TOT_ORD_AMT
		            , TEM.ORD_NO AS BOS_ORD_NO
		            , '' AS POS_ORD_NO
		        FROM (
		            SELECT 
		                ITG_CUST_NO
		                , SUM(SETL_AMT) AS SETL_AMT
		                , SUM(ORD_AMT) AS ORD_AMT
		                , SUM(CNTR_PD_VAL) AS CNTR_PD_VAL
		                , SUM(RENT_AMT) AS RENT_AMT
		                , SALE_TY_CD
		                , SALE_ORGZ_CUST_CD
		                , ORD_NO
		            FROM CRM_CUST_BOS_CNTRT_HST A 
		                WHERE IST_DCS_DE IS NOT NULL 
		                    AND IST_DCS_DE <![CDATA[>=]]> #{promStaYmd} AND IST_DCS_DE <![CDATA[<=]]> #{promEndYmd}
		                    AND SALE_ORGZ_CUST_CD IN (SELECT STOR_NO FROM CRM_MSHIP_APPLY_STOR_REL WHERE MSHIP_PROM_BAS_NO = #{mshipPromBasNo})
		                    AND BASE_ITEM_CD IN (SELECT GODS_NO FROM CRM_MSHIP_APPLY_GODS_REL WHERE MSHIP_PROM_BAS_NO = #{mshipPromBasNo})
		                    AND CNTR_STS_DTL_CD = '32'  /*매출확정*/  
		                    AND SETL_STS_CD = '20'      /*결제완료*/ 
		                    AND IST_STS_CD = '50'       /*설치확정*/ 
		                    AND IST_DCS_YN = 'Y'        /*설치확정여부*/ 
		                GROUP BY ITG_CUST_NO , SALE_TY_CD , SALE_ORGZ_CUST_CD , ORD_NO
		                ORDER BY ITG_CUST_NO DESC 
		        )TEM
		        
		        UNION ALL 
		        
		        SELECT 
		            TEM.ITG_CUST_NO 
		            , TEM.TOT_AMT AS TOT_ORD_AMT 
		            , '' AS BOS_ORD_NO
		            , (TEM.SALE_DATE||TEM.STOR_NO||TEM.POS_NO||TEM.DEAL_NO) AS POS_ORD_NO
		         FROM (
		            SELECT
		                A.SALE_DATE
		                , A.STOR_NO
		                , A.POS_NO
		                , A.DEAL_NO
		                , B.ITG_CUST_NO   
		                , SUM(A.TOT_SALE_AMT) AS TOT_AMT
		                , SUM(A.DC_AMT) AS DC_AMT
		             FROM CRM_CUST_POS_SALE_DTL A JOIN CRM_CUST_POS_SALE_HST B ON A.SALE_DATE = B.SALE_DATE
		                AND A.STOR_NO = B.STOR_NO 
		                AND A.POS_NO = B.POS_NO
		                AND A.DEAL_NO = B.DEAL_NO
		                AND B.ITG_CUST_NO IS NOT NULL
		                AND A.STOR_NO IN (SELECT STOR_NO FROM CRM_MSHIP_APPLY_STOR_REL WHERE MSHIP_PROM_BAS_NO = #{mshipPromBasNo})
		                AND A.GODS_NO IN (SELECT GODS_NO FROM CRM_MSHIP_APPLY_GODS_REL WHERE MSHIP_PROM_BAS_NO = #{mshipPromBasNo})
		                AND A.SALE_DATE <![CDATA[>=]]> #{promStaYmd} AND A.SALE_DATE <![CDATA[<=]]> #{promEndYmd}
		                AND A.DEAL_DIV_CD = 0
		                GROUP BY A.SALE_DATE , A.STOR_NO , A.POS_NO , A.DEAL_NO , B.ITG_CUST_NO 
		        ) TEM
		    ) GRP GROUP BY GRP.ITG_CUST_NO
		) RE  
		<trim prefix="WHERE (" prefixOverrides="AND" suffix=")">
           <if test="fromApplySaleCondCd eq '01'">
	    		AND RE.TOT_ORD_AMT <![CDATA[>=]]> replace(#{fromApplySaleAmt},',','')
	    	</if>
	    	<if test="fromApplySaleCondCd eq '02'">
	    		AND RE.TOT_ORD_AMT <![CDATA[>]]> replace(#{fromApplySaleAmt},',','')
	    	</if>
	    	<if test="toApplySaleCondCd eq '01'">
	    		AND RE.TOT_ORD_AMT <![CDATA[<=]]> replace(#{toApplySaleAmt},',','')
	    	</if>
	    	<if test="toApplySaleCondCd eq '02'">
	    		AND RE.TOT_ORD_AMT <![CDATA[<]]> replace(#{toApplySaleAmt},',','')
	    	</if>
         </trim> 
    </select>
	
	<select id="getBosOrderList" resultType="EzMap">
        <include refid="com.ceragem.crm.sys.dao.CrmCommonDao.pagingHeader"/>
         	SELECT 
              		TEM2.CNTR_NO                    /*계약번호        */
                   , TEM2.CUST_NO                    /*고객번호        */
                   , TEM2.CUST_NM                    /*고객명        */
                   , TEM2.ITG_CUST_NO                    /*계약자 통합고객번호        */
                   , TEM2.CUST_TY_CD                    /*고객유형코드        */
                   , TEM2.CUST_TY_CDNM                    /*고객유형명        */
                   , TEM2.CUST_TY_DTL_CD                    /*고객유형상세코드        */
                   , TEM2.CUST_TY_DTL_CDNM                    /*고객유형상세명        */
                   , TEM2.ORD_NO                    /*주문번호        */
                   , TEM2.ORD_NO_SN                    /*주문번호순번        */
                   , TEM2.ORD_DE                    /*주문일자        */
                   , TEM2.ORD_STS_CD                    /*주문상태코드        */
                   , TEM2.ORD_STS_CDNM                    /*주문상태명        */
                   , TEM2.ORD_CHN_CD                    /*주문채널코드        */
                   , TEM2.ORD_SE_CD                    /*주문구분코드        */
                   , TEM2.ORD_SE_CDNM                    /*주문구분명        */
                   , TEM2.ORD_CNCL_DE                    /*주문취소일자        */
                   , TEM2.ITEM_CD                    /*품목코드        */
                   , TEM2.ITEM_NM                    /*품목명        */
                   , TEM2.ITEM_GRP_CD                    /*품목그룹코드        */
                   , TEM2.ITEM_GRP_CDNM                    /*품목그룹명        */
                   , TEM2.ITEM_TY_CD                    /*품목유형코드        */
                   , TEM2.ITEM_TY_CDNM                    /*품목유형명        */
                   , TEM2.ITEM_TY_DTL_CD                    /*품목유형상세코드        */
                   , TEM2.ITEM_TY_DTL_CDNM                    /*품목유형상세명        */
                   , TEM2.SERIAL_NO                    /*시리얼번호        */
                   , TEM2.SALE_TY_CD                    /*판매유형코드        */
                   , TEM2.SALE_TY_CDNM                    /*판매유형명        */
                   , TEM2.SALE_SE_CD                    /*판매구분코드        */
                   , TEM2.SALE_SE_CDNM                    /*판매구분명        */
                   , TEM2.SALE_GRP_CD                    /*판매그룹코드        */
                   , TEM2.SALE_GRP_CDNM                    /*판매그룹명        */
                   , TEM2.CNTR_STS_CD                    /*계약상태코드        */
                   , TEM2.CNTR_STS_CDNM                    /*계약상태명        */
                   , TEM2.CNTR_STS_DTL_CD                    /*계약상태상세코드        */
                   , TEM2.CNTR_STS_DTL_CDNM                    /*계약상태상세명        */
                   , TEM2.CNTR_STS_DTL_RSN                    /*계약상태상세사유        */
                   , TEM2.SETL_STS_CD                    /*결제상태코드        */
                   , TEM2.SETL_STS_CDNM                    /*결제상태명        */
                   , TEM2.IST_STS_CD                    /*설치상태코드        */
                   , TEM2.IST_STS_CDNM                    /*설치상태명        */
                   , TEM2.CNTR_CNCL_YN                    /*계약취소여부        */
                   , TEM2.CNTR_CNCL_DE                    /*계약취소일자        */
                   , TEM2.CNTR_CNCL_RSN                    /*계약취소사유        */
                   , TEM2.HQ_SE_CD                    /*본부구분코드        */
                   , TEM2.SELLER                    /*판매인        */
                   , TEM2.SELLERNM                    /*판매인명        */
                   , TEM2.SALE_ORGZ                    /*판매조직        */
                   , TEM2.IST_DUE_ORGZ                    /*설치예정조직        */
                   , TEM2.IST_DUE_ENGR                    /*설치예정기사        */
                   , TEM2.IST_ORGZ                    /*설치조직        */
                   , TEM2.IST_ENGR                    /*설치기사        */
                   , TEM2.EQP_NO                    /*설비번호        */
                   , TEM2.WRH_CD                    /*창고코드        */
                   , TEM2.WRH_NM                    /*창고명        */
                   , TEM2.CNTC_SN                    /*컨택순번        */
                   , TEM2.CUST_CNTC_STS                    /*고객컨택상태        */
                   , TEM2.CUST_CNTC_DE                    /*고객컨택일자        */
                   , TEM2.IST_REQ_DE                    /*설치요청일자        */
                   , TEM2.IST_DE                    /*설치일자        */
                   , TEM2.IST_DCS_YN                    /*설치확정여부        */
                   , TEM2.IST_DCS_DE                    /*설치확정일자        */
                   , TEM2.CNTR_START_DE                    /*계약시작일자        */
                   , TEM2.CNTR_END_DUE_DE                    /*계약종료예정일자        */
                   , TEM2.CNTR_END_YN                    /*계약종료여부        */
                   , TEM2.CNTR_END_DE                    /*계약종료일자        */
                   , TEM2.SELNG_DCS_YN                    /*매출확정여부        */
                   , TEM2.SELNG_DCS_DE                    /*매출확정일자        */
                   , TEM2.CDT_SEL_YN                    /*신용조회여부        */
                   , TEM2.PRC_PLC_NO                    /*가격정책번호        */
                   , TEM2.AGR_PD_CD                    /*약정기간코드        */
                   , TEM2.AGR_PD_CDNM                    /*약정기간명        */
                   , TEM2.CNTR_PD_VAL                    /*계약기간값        */
                   , TEM2.SVC_PD_CD                    /*서비스기간코드        */
                   , TEM2.SVC_CYCLE                    /*점검주기        */
                   , TEM2.PREPAY_YN                    /*선납여부        */
                   , TEM2.PREPAY_AMT                    /*선납금액        */
                   , TEM2.PREPAY_CYCLE                    /*선납주기        */
                   , TEM2.PREPAY_DCRT                    /*선납할인율        */
                   , TEM2.REGFEE                    /*등록비        */
                   , TEM2.ISTCT                    /*설치비        */
                   , TEM2.DFEE                    /*해체비        */
                   , TEM2.BASS_RENT_AMT                    /*기본렌탈금액        */
                   , TEM2.RENT_AMT                    /*렌탈금액        */
                   , TEM2.BASS_SALE_AMT                    /*기본판매금액        */
                   , TEM2.SALES_AMT                    /*판매금액        */
                   <!-- , TEM2.SETL_AMT                    /*결제금액        */ -->
                   , CASE
		                WHEN TEM2.SALE_TY_CD = '1401' OR TEM2.SALE_TY_CD = '1402' OR TEM2.SALE_TY_CD = '1403' OR TEM2.SALE_TY_CD = '1404' THEN (TEM2.SETL_AMT + TEM2.RENT_AMT) * TEM2.CNTR_PD_VAL
		                WHEN TEM2.SALE_TY_CD = '2101' OR TEM2.SALE_TY_CD = '2102' OR TEM2.SALE_TY_CD = '2103' OR TEM2.SALE_TY_CD = '2104' OR TEM2.SALE_TY_CD = '1202' THEN TEM2.SETL_AMT
		                WHEN TEM2.SALE_TY_CD = '2401' THEN TEM2.SETL_AMT
		            END SETL_AMT
                   , TEM2.ORD_AMT                    /*주문금액        */
                   , TEM2.ORD_VAT_EXCL_AMT                    /*주문부가세제외금액        */
                   , TEM2.ORD_VAT_AMT                    /*주문부가세금액        */
                   , TEM2.SELNG_AMT                    /*매출금액        */
                   , TEM2.SELNG_VAT_EXCL_AMT                    /*매출부가세제외금액        */
                   , TEM2.SELNG_VAT_AMT                    /*매출부가세금액        */
                   , TEM2.SELNG_NO                    /*매출번호        */
                   , TEM2.VAT_CD                    /*부가세코드        */
                   , TEM2.SALE_CHN_CD                    /*판매채널코드        */
                   , TEM2.SALE_CHN_CDNM                    /*판매채널명        */
                   , TEM2.PRMT_YN                    /*프로모션여부        */
                   , TEM2.PRMT_PLC_NO                    /*프로모션정책번호        */
                   , TEM2.PRMT_NO                    /*프로모션번호        */
                   , TEM2.PKG_YN                    /*패키지여부        */
                   , TEM2.PKG_PLC_NO                    /*패키지정책번호        */
                   , TEM2.PKG_NO                    /*패키지번호        */
                   , TEM2.GRP_YN                    /*단체여부        */
                   , TEM2.GRP_CD                    /*단체코드        */
                   , TEM2.GRP_NO                    /*단체번호        */
                   , TEM2.CTRTC_FILE_NO                    /*계약서파일번호        */
                   , TEM2.SIGN_FILE_NO                    /*서명파일번호        */
                   , TEM2.SVC_YN                    /*서비스여부        */
                   , TEM2.EXIST_CNTR_NO                    /*기존계약번호        */
                   , TEM2.RTGD_TY_CD                    /*반품유형코드        */
                   , TEM2.RTGD_REQ_DE                    /*반품요청일자        */
                   , TEM2.RTGD_DCS_YN                    /*반품접수확정여부        */
                   , TEM2.RTGD_END_DE                    /*반품완료일자        */
                   , TEM2.SPLT_PLC_NO                    /*약관정책번호        */
                   , TEM2.IST_DUE_DE                    /*설치예정일자        */
                   , TEM2.ADD_PRUF_FILE_NO1                    /*추가증빙파일번호1        */
                   , TEM2.ADD_PRUF_FILE_NO2                    /*추가증빙파일번호2        */
                   , TEM2.CDT_GRAD_CD                    /*신용등급코드        */
                   , TEM2.REG_USR_ID                    /*등록자ID        */
                   , TEM2.REG_DT                    /*등록일시        */
                   , TEM2.UPD_USR_ID                    /*수정자ID        */
                   , TEM2.UPD_DT                    /*수정일시        */
                   , TEM2.POST_NO                    /*설치-우편번호        */
                   , TEM2.BASS_ADDR                    /*설치-기본주소        */
                   , TEM2.DTL_ADDR                    /*설치-상세주소        */
                   , TEM2.MOB_NO                    /*설치-모바일번호        */
                   , TEM2.TEL_NO                    /*설치-전화번호        */
                   , TEM2.PARTCLR_MATTER                    /*설치-특이사항        */
                   , TEM2.IST_CUST_NM                    /*설치-설치고객명        */
                   , TEM2.CARD_NO                    /*정기결제-카드번호        */
                   , TEM2.CDCMP_CD                    /*정기결제-카드사코드        */
                   , TEM2.OWNER_NM                    /*정기결제-소유주명        */
                   , TEM2.FSETL_MTH_CD                    /*정기결제-방법코드        */
                   , TEM2.FSETL_MTH_CDNM                    /*정기결제-방법명        */
                   , TEM2.FSETL_DE_CD                    /*정기결제일자코드        */
                   , TEM2.ACCT_AFILE_NO                    /*계좌신청동의파일번호        */
                   , TEM2.OTBN_STS_CD                    /*출고상태코드        */
                   , TEM2.OTBN_STS_CDNM                    /*출고상태명        */
                   , TEM2.RM                    /*비고        */
                   , TEM2.BASS_MBRSH_AMT                    /*기본멤버십금액        */
                   , TEM2.MBRSH_AMT                    /*멤버십금액        */
                   , TEM2.LMPS_FREE_END_DUE_DE                    /*일시불무상종료예정일        */
                   , TEM2.PKG_TRMN_YN                    /*패키지해지여부        */
                   , TEM2.DLV_TY_CD                    /*배송유형코드        */
                   , TEM2.DLV_TY_CDNM                    /*배송유형명        */
                   , TEM2.DLV_TY_DTL_CD                    /*배송유형상세코드        */
                   , TEM2.DLV_TY_DTL_CDNM                    /*배송유형상세명        */
                   , TEM2.AGR_PD_VAL                    /*약정기간값        */
                   , TEM2.CNTR_PD_SE_CD                    /*계약기간구분코드        */
                   , TEM2.CNTR_PD_SE_CDNM                    /*계약기간구분명        */
                   , TEM2.CNTR_END_AFTER_PROC_MTH_CD                    /*계약이후처리방법코드        */
                   , TEM2.CNTR_END_AFTER_PROC_MTH_CDNM                    /*계약종료이후처리방법        */
                   , TEM2.UATC_SE_CD                    /*중고구분코드        */
                   , TEM2.UATC_SE_CDNM                    /*중고구분명        */
                   , TEM2.UATC_GRAD_CD                    /*중고등급코드        */
                   , TEM2.UATC_GRAD_CDNM                    /*중고등급명        */
                   , TEM2.SHDE_CRE_YN                    /*스케줄생성여부        */
                   , TEM2.RENT_SE_CD                    /*렌탈구분코드        */
                   , TEM2.RENT_SE_CDNM                    /*렌탈구분명        */
                   , TEM2.EXPRN_DMD_DC_PD_CD                    /*홈체험청구할인기간코드        */
                   , TEM2.EXPRN_DMD_DC_PD_CDNM                    /*홈체험청구할인기간명        */
                   , TEM2.EXPRN_CNTR_NO                    /*홈체험계약번호        */
                   , TEM2.RCMDR                    /*추천인        */
                   , TEM2.RCMDRNM                    /*추천인명        */
                   , TEM2.ORGZ_CD                    /*추천인조직코드        */
                   , TEM2.ORGZ_NM                    /*추천인조직명        */
                   , TEM2.SELF_BSN_SE_CD                    /*본인영업구분코드        */
                   , TEM2.SELF_BSN_SE_CDNM                    /*본인영업구분명        */
                   , TEM2.PRSNT_DTLS                    /*사은품내역        */
                   , TEM2.FREE_SALE_TY                    /*무상판매유형        */
                   , TEM2.FREE_SALE_TYNM                    /*무상판매유형명        */
                   , TEM2.MNG_NO                    /*관리번호        */
                   , TEM2.CNTC_STS_CDNM                    /*컨택상태명        */
                   , TEM2.BASS_SALE_FEE                    /*기본판매요금        */
                   , TEM2.PRC_PLC_NM                    /*가격정책명        */
                   , TEM2.CNTR_QY                    /*계약수량        */
                   , TEM2.DCRT                    /*할인율        */
                   , TEM2.DC_AMT                    /*할인금액        */
                   , TEM2.ER_CNTR_NO                    /*이지렌탈계약번호        */
                   , TEM2.RPRSNTV_CNTR_YN                    /*대표번호여부        */
                   , TEM2.OR_TY_CD                    /*주문유형코드        */
                   , TEM2.OR_TY_CDNM                    /*주문유형        */
                   , TEM2.PRSNT_YN                    /*사은품여부        */
                   , TEM2.PRSNT_CNTR_NO                    /*원계약번호(사은품)        */
                   , TEM2.CERAM_ORD_NO                    /*건기식주문번호        */
                   , TEM2.PTAXBIL_YN                    /*선세금계산서발급여부        */
                   , TEM2.PTAXBIL_DE                    /*선세금계산서기준일자        */
                   , TEM2.PTAXBIL_CHRGR_SN                    /*선세금계산서담당자        */
                   , TEM2.CHRGR_EMAIL                    /*담당자이메일        */
                   , TEM2.CHRGR_CTTPC                    /*담당자연락처        */
                   , TEM2.CHRGR_DEPT_NM                    /*담당자부서명        */
                   , TEM2.RCMDR_MBRSH_ID                    /*추천고객멤버십아이디        */
                   , TEM2.RCMDR_MBRSH_NM                    /*추천고객멤버십이름        */
                   , TEM2.CFILE_NO                    /*인수서파일번호        */
                   , TEM2.INS_SER_NO                    /*조견표번호        */
                   , TEM2.BOND_CD                    /*채권분류코드        */
                   , TEM2.BOND_CDNM                    /*채권분류명        */
                   , TEM2.USE_COUPN_BAS_NO                    /*사용쿠폰기본번호        */
                   , TEM2.USE_POINT_AMT                    /*사용포인트금액        */
               FROM CRM_CUST_BOS_CNTRT_HST TEM2 JOIN CRM_CUST_BAS CUT ON TEM2.ITG_CUST_NO = CUT.ITG_CUST_NO
               <if test="bosOrdNos != null and bosOrdNos != ''" > 
               		AND ('ORD_NO',TEM2.ORD_NO) IN
				<foreach item="item" index="index" collection="bosOrdNos" open="(" separator="," close=")">
					('ORD_NO',#{item})
				</foreach>
	           </if>
	           <if test="godsNm != null and godsNm != ''" >
	           		AND TEM2.ITEM_NM LIKE '%' ||  #{godsNm} || '%'
	           </if>
	           <if test="custNm != null and custNm != ''" >
	           		AND TEM2.IST_CUST_NM  = #{custNm}
	           </if>
	           <if test="itgCustNo != null and itgCustNo != ''" >
	           		AND TEM2.ITG_CUST_NO   = #{itgCustNo}
	           </if>
	           <!-- <if test="orderStaYmd != null and orderEndYmd != ''" >
	           		AND TEM2.ORD_DE <![CDATA[>=]]> #{orderStaYmd} AND TEM2.ORD_DE <![CDATA[<=]]> #{orderEndYmd}
	           </if> -->
	          <!--  JOIN CRM_CUST_BAS CUT ON TEM1.ITG_CUST_NO = CUT.ITG_CUST_NO  -->
	           <trim prefix="AND (" prefixOverrides="OR" suffix=")">
		            <if test="typeCd != null and typeCd != ''" >
						OR CUT.MSHIP_TYPE_CD      IN 
						<foreach item="item" index="index" collection="typeCd" open="(" separator="," close=")">
							#{item}
						</foreach>
					</if>
					<if test="gradeCd != null and gradeCd != ''">
						OR CUT.MSHIP_GRADE_CD      IN 
						<foreach item="item" index="index" collection="gradeCd" open="(" separator="," close=")">
							#{item}
						</foreach>
					</if>
					<if test="cmpNo != null and cmpNo != ''">
			    		OR CUT.CPRT_CMP_NO = #{cmpNo}
			    	</if>
	           </trim>
        <include refid="com.ceragem.crm.sys.dao.CrmCommonDao.pagingFooter"/>
    </select>
        
    <select id="getBosOrderListCount" resultType="int">
    	SELECT 
        	COUNT(1)      	
               FROM CRM_CUST_BOS_CNTRT_HST TEM2 JOIN CRM_CUST_BAS CUT ON TEM2.ITG_CUST_NO = CUT.ITG_CUST_NO 
               <if test="bosOrdNos != null and bosOrdNos != ''" >
               	AND ('ORD_NO',TEM2.ORD_NO) IN
				<foreach item="item" index="index" collection="bosOrdNos" open="(" separator="," close=")">
					('ORD_NO',#{item})
				</foreach>
				</if>
	           <if test="godsNm != null and godsNm != ''" >
	           		AND TEM2.ITEM_NM LIKE '%' ||  #{godsNm} || '%'
	           </if>
	           <!-- <if test="orderStaYmd != null and orderEndYmd != ''" >
	           		AND TEM2.ORD_DE <![CDATA[>=]]> #{orderStaYmd} AND TEM2.ORD_DE <![CDATA[<=]]> #{orderEndYmd}
	           </if> -->
	           <if test="custNm != null and custNm != ''" >
	           		AND TEM2.IST_CUST_NM   = #{custNm}
	           </if>
	           <if test="itgCustNo != null and itgCustNo != ''" >
	           		AND TEM2.ITG_CUST_NO   = #{itgCustNo}
	           </if>
	           <!-- JOIN CRM_CUST_BAS CUT ON TEM1.ITG_CUST_NO = CUT.ITG_CUST_NO --> 
	           <trim prefix="AND (" prefixOverrides="OR" suffix=")">
		            <if test="typeCd != null and typeCd != ''" >
						OR CUT.MSHIP_TYPE_CD      IN 
						<foreach item="item" index="index" collection="typeCd" open="(" separator="," close=")">
							#{item}
						</foreach>
					</if>
					<if test="gradeCd != null and gradeCd != ''">
						OR CUT.MSHIP_GRADE_CD      IN 
						<foreach item="item" index="index" collection="gradeCd" open="(" separator="," close=")">
							#{item}
						</foreach>
					</if>
					<if test="cmpNo != null and cmpNo != ''">
			    		OR CUT.CPRT_CMP_NO = #{cmpNo}
			    	</if>
	           </trim>
    </select>
    
    
   	<select id="getPosOrderList" resultType="EzMap">
        <include refid="com.ceragem.crm.sys.dao.CrmCommonDao.pagingHeader"/>
        	SELECT 
			    TEM1.SALE_DATE
			    , TEM1.STOR_NO
			    , TEM1.POS_NO
			    , TEM1.DEAL_NO
			    , STR.STOR_NM
			    , TEM1.ITG_CUST_NO 
			    , CUT.CUST_NM 
			    , TEM1.GODS_NO 
			    , GOD.GODS_NM 
			    , GOD.GODS_CLASS_CD
			    , TEM1.TOT_AMT
			    , TEM1.DC_AMT
			    , TEM1.ORD_NO
			 FROM (
			    SELECT
			        A.SALE_DATE
			        , A.STOR_NO
			        , A.POS_NO
			        , A.DEAL_NO
			        , B.ITG_CUST_NO  
			        , A.GODS_NO  
			        , SUM(A.TOT_SALE_AMT) AS TOT_AMT
			        , SUM(A.DC_AMT) AS DC_AMT
			        , (A.SALE_DATE||A.STOR_NO||A.POS_NO||A.DEAL_NO) AS ORD_NO
			     FROM CRM_CUST_POS_SALE_DTL A JOIN CRM_CUST_POS_SALE_HST B ON A.SALE_DATE = B.SALE_DATE
			        AND A.STOR_NO = B.STOR_NO 
			        AND A.POS_NO = B.POS_NO
			        AND A.DEAL_NO = B.DEAL_NO
			        AND B.ITG_CUST_NO IS NOT NULL
			        GROUP BY A.SALE_DATE,A.STOR_NO,A.POS_NO,A.DEAL_NO,B.ITG_CUST_NO, A.GODS_NO
			) TEM1 JOIN CRM_STOR_BAS STR ON TEM1.STOR_NO = STR.STOR_NO
				<if test="posOrdNos != null and posOrdNos != ''" >
				AND ('ORD_NO',TEM1.ORD_NO) IN
				<foreach item="item" index="index" collection="posOrdNos" open="(" separator="," close=")">
					('ORD_NO',#{item})
				</foreach>
				</if>
			       JOIN CRM_CUST_BAS CUT ON TEM1.ITG_CUST_NO = CUT.ITG_CUST_NO
		       <if test="custNm != null and custNm != ''" >
           			AND CUT.CUST_NM   =  #{custNm}
	           </if>
		       <if test="itgCustNo != null and itgCustNo != ''" >
           			AND CUT.ITG_CUST_NO   =  #{itgCustNo}
	           </if>
			   <trim prefix="AND (" prefixOverrides="OR" suffix=")">
		            <if test="typeCd != null and typeCd != ''" >
						OR CUT.MSHIP_TYPE_CD      IN 
						<foreach item="item" index="index" collection="typeCd" open="(" separator="," close=")">
							#{item}
						</foreach>
					</if>
					<if test="gradeCd != null and gradeCd != ''">
						OR CUT.MSHIP_GRADE_CD      IN 
						<foreach item="item" index="index" collection="gradeCd" open="(" separator="," close=")">
							#{item}
						</foreach>
					</if>
					<if test="cmpNo != null and cmpNo != ''">
			    		OR CUT.CPRT_CMP_NO = #{cmpNo}
			    	</if>
	           </trim>
			       JOIN CRM_GODS_BAS GOD ON TEM1.GODS_NO = GOD.GODS_NO 
			   <if test="godsNm != null and godsNm != ''" >
	           		AND GOD.GODS_NM LIKE '%' ||  #{godsNm} || '%'
	           </if>
			       ORDER BY TEM1.SALE_DATE DESC 
        <include refid="com.ceragem.crm.sys.dao.CrmCommonDao.pagingFooter"/>
    </select>
    
    
    <select id="getPosOrderListCount" resultType="int">
    	SELECT 
			    COUNT(1) AS CNT
			 FROM (
			    SELECT
			        A.SALE_DATE
			        , A.STOR_NO
			        , A.POS_NO
			        , A.DEAL_NO
			        , B.ITG_CUST_NO  
			        , A.GODS_NO  
			        , SUM(A.TOT_SALE_AMT) AS TOT_AMT
			        , SUM(A.DC_AMT) AS DC_AMT
			        , (A.SALE_DATE||A.STOR_NO||A.POS_NO||A.DEAL_NO) AS ORD_NO
			     FROM CRM_CUST_POS_SALE_DTL A JOIN CRM_CUST_POS_SALE_HST B ON A.SALE_DATE = B.SALE_DATE
			        AND A.STOR_NO = B.STOR_NO 
			        AND A.POS_NO = B.POS_NO
			        AND A.DEAL_NO = B.DEAL_NO
			        AND B.ITG_CUST_NO IS NOT NULL
			        GROUP BY A.SALE_DATE,A.STOR_NO,A.POS_NO,A.DEAL_NO,B.ITG_CUST_NO, A.GODS_NO
			) TEM1 JOIN CRM_STOR_BAS STR ON TEM1.STOR_NO = STR.STOR_NO
				<if test="posOrdNos != null and posOrdNos != ''" >	
					AND ('ORD_NO',TEM1.ORD_NO) IN
					<foreach item="item" index="index" collection="posOrdNos" open="(" separator="," close=")">
						('ORD_NO',#{item})
					</foreach>
				</if>
			       JOIN CRM_CUST_BAS CUT ON TEM1.ITG_CUST_NO = CUT.ITG_CUST_NO
			   <if test="custNm != null and custNm != ''" >
           			AND CUT.CUST_NM   = #{custNm}
	           </if>
	           <if test="itgCustNo != null and itgCustNo != ''" >
           			AND CUT.ITG_CUST_NO   =  #{itgCustNo}
	           </if>
			   <trim prefix="AND (" prefixOverrides="OR" suffix=")">
		            <if test="typeCd != null and typeCd != ''" >
						OR CUT.MSHIP_TYPE_CD      IN 
						<foreach item="item" index="index" collection="typeCd" open="(" separator="," close=")">
							#{item}
						</foreach>
					</if>
					<if test="gradeCd != null and gradeCd != ''">
						OR CUT.MSHIP_GRADE_CD      IN 
						<foreach item="item" index="index" collection="gradeCd" open="(" separator="," close=")">
							#{item}
						</foreach>
					</if>
					<if test="cmpNo != null and cmpNo != ''">
			    		OR CUT.CPRT_CMP_NO = #{cmpNo}
			    	</if>
	           </trim>
			       JOIN CRM_GODS_BAS GOD ON TEM1.GODS_NO = GOD.GODS_NO 
			   <if test="godsNm != null and godsNm != ''" >
	           		AND GOD.GODS_NM LIKE '%' ||  #{godsNm} || '%'
	           </if>
    </select>
        
    <select id="getPointList" resultType="com.ceragem.crm.mem.model.PromotionListVo">
        <include refid="com.ceragem.crm.sys.dao.CrmCommonDao.pagingHeader"/>
               SELECT 
               		  POINT_HST_SEQ		/* 포인트이력일련번호 */
					, ITG_CUST_NO		/* 통합고객번호 */
					, MSHIP_GRADE_CD	/* 멤버십등급코드 */
					, STOR_NO			/* 매장번호 */
					, CHIT_NO			/* 전표번호 */
					, BUY_GODS_NO		/* 구매제품번호 */
					, ORDR_AMT        	/* 주문금액 */
					, APPLY_AMT        	/* 적용금액 */
					, PAY_AMT       	/* 결제금액 */
					, PBLS_DIV_CD       /* 발행구분코드 */
					, OCCUR_POINT_SCORE	/* 발생포인트점수 */
					, REMAIN_POINT_SCORE/* 잔여포인트점수 */
					, CASE WHEN TO_DATE(VALID_PERD_END_YMD,'YYYYMMDD') - TO_DATE(TO_CHAR(PBLS_DT,'YYYYMMDD'),'YYYYMMDD') IS NULL THEN ''
						   ELSE TO_DATE(VALID_PERD_END_YMD,'YYYYMMDD') - TO_DATE(TO_CHAR(PBLS_DT,'YYYYMMDD'),'YYYYMMDD') + 1 || '일'
						   END AS VALID_PERD /* 유효기간 */
					, VALID_PERD_STA_YMD/* 유효기간시작년월일 */
					, VALID_PERD_END_YMD/* 유효기간종료년월일 */
					, PBLS_DT 			/* 발생일시 */
					, EXTNC_DT 			/* 소멸일시 */
					, TXN 				/* 내역 */
					, PBLS_CHL_CD 		/* 발생채널코드 */                                                                                                                                                                                                                  
					, CARD_PBLS_HST_SEQ	/* 카드발행이력일련번호 */
					, DEAL_NO           /* 거래번호 */
					, PROM_NO           /* 프로모션번호 */
					, CAMP_NO           /* 캠페인번호 */
					, COUPN_NO          /* 쿠폰번호 */
					, USE_DT            /* 사용일시 */
					, USE_TYPE_CD       /* 사용유형코드 */
					, USE_TYPE_CD AS USE_TYPE_NM 																					/* 사용유형코드 */
					, (SELECT CUST_NM FROM CRM_CUST_BAS WHERE ITG_CUST_NO = P.ITG_CUST_NO) AS CUST_NM 								/* 고객명 */
					, (SELECT MPHON_NO FROM CRM_CUST_BAS WHERE ITG_CUST_NO = P.ITG_CUST_NO) AS MPHON_NO 							/* 고객전화번호 */
					, (SELECT STOR_NM FROM CRM_STOR_BAS WHERE STOR_NO = P.STOR_NO) AS STOR_NM 										/* 매장명 */
					, (SELECT REMAIN_POINT_SCORE FROM CRM_CUST_BAS WHERE ITG_CUST_NO = P.ITG_CUST_NO) AS CUST_REMAIN_POINT_SCORE 	/* 잔여포인트 */
					, AMDR_ID		    /* 수정자ID */
					, AMD_DT		    /* 수정일시 */
					, REGR_ID		    /* 등록자ID */
					, REG_DT		    /* 등록일시 */
					, REG_CHL_CD 	    /* 등록채널코드 */
                FROM 
                 	  CRM_POINT_HST P
               WHERE 
               		  PROM_NO = #{mshipPromBasNo}
                <if test="useTypeCd != null and useTypeCd != ''">
	                  AND USE_TYPE_CD       =       #{useTypeCd}
	        	</if>
        		<if test="pointStaYmd != null and pointStaYmd != ''">
                  	  AND PBLS_DT >= TO_DATE(#{pointStaYmd},'YYYYMMDD')
		        </if>
		        <if test="pointEndYmd != null and pointEndYmd != ''">
		              AND TO_DATE(#{pointEndYmd},'YYYYMMDD') + 1 > PBLS_DT
		        </if>
            ORDER BY 
            		  PBLS_DT DESC
        <include refid="com.ceragem.crm.sys.dao.CrmCommonDao.pagingFooter"/>
    </select>
        
    <select id="getPointListCount" resultType="int">
                SELECT COUNT(1)
                 FROM CRM_POINT_HST
        		WHERE PROM_NO = #{mshipPromBasNo}
    </select>
    
    <select id="getCoupnList" resultType="com.ceragem.crm.mem.model.PromotionListVo">
        <include refid="com.ceragem.crm.sys.dao.CrmCommonDao.pagingHeader"/>
         	 SELECT * FROM
               (SELECT  
                        A.USE_DT							/* 사용일시 */
						, A.REG_DT							/* 등록일시 */
						<!-- ,CASE
							WHEN A.USE_DIV_CD = '001' THEN TO_DATE(A.USE_DT,'YYYYMMDDHH24MISS')
							WHEN A.USE_DIV_CD = '002' THEN A.REG_DT
							ELSE TO_DATE(A.USE_DT,'YYYYMMDDHH24MISS')
						END AS DT							/* 사용구분:사용-사용일시, 적립-등록일시, 취소-'CST22061017580675697'대기 */ -->
						, A.COUPN_PBLS_BAS_NO
						,CASE
							WHEN A.USE_YN = 'Y' THEN TO_DATE(A.USE_DT,'YYYYMMDDHH24MISS')
							ELSE A.REG_DT
						END AS DT
						, A.ITG_CUST_NO						/* 통합고객번호*/
						, (SELECT CUST_NM FROM CRM_CUST_BAS WHERE ITG_CUST_NO = A.ITG_CUST_NO) AS CUST_NM
						, A.USE_DIV_CD						/* 사용구분코드*/
						, A.USE_YN AS USE_DIV_NM		/* 사용구분*/
						, A.COUPN_TYPE_CD					/* 쿠폰유형코드*/
						, A.COUPN_TYPE_CD AS COUPN_TYPE_NM	/* 쿠폰유형*/
						, A.COUPN_KND_CD					/* 쿠폰종류코드*/
						, A.COUPN_KND_CD AS COUPN_KND_NM	/* 쿠폰종류*/
						, A.COUPN_BAS_NM					/* 쿠폰기본명*/
						, A.STOR_NO							/* 매장번호*/
						, B.STOR_NM							/* 매장명 */
						, B.STOR_CHL_CD     				/* 매장채널명 */
						, A.REG_CHL_CD						/* 등록채널코드 */
						, A.REG_CHL_CD AS REG_CHL_NM		/* 등록채널코드 */
						, A.PROM_NO							/* 프로모션번호 */

                 FROM CRM_COUPN_PBLS_HST A, CRM_STOR_BAS B
                 WHERE A.STOR_NO = B.STOR_NO(+)) B
             WHERE
             		PROM_NO = #{mshipPromBasNo}
             	<if test="coupnStaYmd != null and coupnStaYmd != ''">
                      AND B.DT      >=       TO_DATE(#{coupnStaYmd},'YYYYMMDD')
		        </if>
		        <if test="coupnEndYmd != null and coupnEndYmd != ''">
		              AND TO_DATE(#{coupnEndYmd},'YYYYMMDD') + 1 > B.DT
		        </if>
		        <if test="useDivCd != null and useDivCd != ''">
		              AND B.USE_DIV_CD      =       #{useDivCd}
		        </if>
		    ORDER BY DT DESC 
        <include refid="com.ceragem.crm.sys.dao.CrmCommonDao.pagingFooter"/>
    </select>
    
    <select id="getCoupnListCount" resultType="int">
                SELECT COUNT(1)
                 FROM CRM_COUPN_PBLS_HST
        		WHERE PROM_NO = #{mshipPromBasNo}
    </select>
    
    <select id="getMaxPromNo" resultType="String">
    	SELECT /*getMaxPromNo*/ MAX(MSHIP_PROM_BAS_NO) AS MSHIP_PROM_BAS_NO FROM CRM_MSHIP_PROM_BAS
    </select>
    
    <insert id="copyPromStore">
    	INSERT /*copyPromStore*/ INTO CRM_MSHIP_APPLY_STOR_REL (
			  MSHIP_PROM_BAS_NO
			, APPLY_DIV_CD
			, STOR_NO
			, AMDR_ID
			, AMD_DT
			, REGR_ID
			, REG_DT
			, REG_CHL_CD
			, STOR_REL_BAS_NO
		)
		SELECT 
		    #{maxPromNo} AS MSHIP_PROM_BAS_NO
			, APPLY_DIV_CD
			, STOR_NO
			, #{amdrId} AS AMDR_ID
			, SYSDATE AS AMD_DT
			, #{regrId} AS REGR_ID
			, SYSDATE AS REG_DT
			, REG_CHL_CD
			, FN_CRM_AUTO_SEQ('STR') AS STOR_REL_BAS_NO
		FROM CRM_MSHIP_APPLY_STOR_REL 
		    WHERE MSHIP_PROM_BAS_NO = #{mshipPromBasNo}
    </insert>
    
    <insert id="copyPromGods">
	    INSERT /*copyPromGods*/ INTO CRM_MSHIP_APPLY_GODS_REL (
			  APPLY_BNFIT_CD
			, APPLY_DIV_CD
			, GODS_NO
			, DC_RATE
			, AMDR_ID
			, AMD_DT
			, REGR_ID
			, REG_DT
			, GODS_REL_BAS_NO
			, MSHIP_PROM_BAS_NO
			, MIN_BUY_AMT
			, ITEM_ACCUM_CNT
		)
		SELECT 
		    APPLY_BNFIT_CD
			, APPLY_DIV_CD
			, GODS_NO
			, DC_RATE
			, #{amdrId} AS AMDR_ID
			, SYSDATE AS AMD_DT
			, #{regrId} AS REGR_ID
			, SYSDATE AS REG_DT
			, FN_CRM_AUTO_SEQ('MRB') AS GODS_REL_BAS_NO
			, #{maxPromNo} AS MSHIP_PROM_BAS_NO
			, MIN_BUY_AMT
			, ITEM_ACCUM_CNT
		 FROM CRM_MSHIP_APPLY_GODS_REL 
		    WHERE MSHIP_PROM_BAS_NO = #{mshipPromBasNo}
    </insert>
    
    <select id="getPromInfo" resultType="EzMap">
    	SELECT 
    		MSHIP_PROM_BAS_NO
			, PROM_STA_YMD
			, PROM_TYPE_CD
			, PROM_END_YMD
			, REGR_ID
			, REG_DT
			, AMDR_ID
			, PROM_BAS_CTNTS
			, AMD_DT
			, REG_CHL_CD
			, ADVM_SHOW_YN
			, USE_CHL_PLCY_CD
			, FROM_APPLY_SALE_AMT
			, TO_APPLY_SALE_AMT
			, FROM_APPLY_SALE_COND_CD
			, TO_APPLY_SALE_COND_CD
			, FROM_APPLY_PAY_AMT
			, TO_APPLY_PAY_AMT
			, FROM_APPLY_PAY_COND_CD
			, TO_APPLY_PAY_COND_CD
			, APPLY_MSHIP_GRADE_CD
			, DUP_USE_YN
			, APPLY_BNFIT_CD
			, COUPN_APPLY_DIV_CD1
			, COUPN_APPLY_DIV_CD2
			, APPLY_DC_RATE
			, APPLY_DC_AMT
			, POINT_ACCUM_RATE
			, STMP_PRV_CNT
			, PRV_COUPN_BAS_NO
			, STATUS_CD
			, PROM_BAS_NM
			, APPLY_MSHP_GRADE_CTNTS
			, APPLY_MSHIP_GRADE_CD1
			, CPRT_CMP_NO
			, APPLY_POINT_SCORE
			, MSHIP_TYPE_CDS
    	FROM CRM_MSHIP_PROM_BAS
    		WHERE MSHIP_PROM_BAS_NO = #{mshipPromBasNo}
    </select>
    
    <select id="getPromStorList" resultType="String">
    	SELECT 
    		STOR_NO
    	FROM CRM_MSHIP_APPLY_STOR_REL 
		    WHERE MSHIP_PROM_BAS_NO = #{mshipPromBasNo}
    </select>
    
    <select id="getPromGodsList" resultType="String">
    	SELECT 
    		GODS_NO
    	FROM CRM_MSHIP_APPLY_GODS_REL 
		    WHERE MSHIP_PROM_BAS_NO = #{mshipPromBasNo}
    </select>
</mapper>
